{
    "name": "Loriot Uplink data converter for Yobiiq SD-1001",
    "type": "UPLINK",
    "debugMode": true,
    "configuration": {
      "scriptLang": "TBEL",
      "decoder": "// Decode an uplink message from a buffer\n// payload - array of bytes\n// metadata - key/value object\n\n/** Decoder **/\n\n// decode payload to string\nvar payloadStr = decodeToString(payload);\n\n// decode payload to JSON\n// var data = decodeToJson(payload);\n\nvar deviceName = 'Device A';\nvar deviceType = 'thermostat';\nvar customerName = 'Customer C';\nvar groupName = 'thermostat devices';\nvar manufacturer = 'Example corporation';\n// use assetName and assetType instead of deviceName and deviceType\n// to automatically create assets instead of devices.\n// var assetName = 'Asset A';\n// var assetType = 'building';\n\n// Result object with device/asset attributes/telemetry data\nvar result = {\n// Use deviceName and deviceType or assetName and assetType, but not both.\n   deviceName: deviceName,\n   deviceType: deviceType,\n// assetName: assetName,\n// assetType: assetType,\n// customerName: customerName,\n   groupName: groupName,\n   attributes: {\n       model: 'Model A',\n       serialNumber: 'SN111',\n       integrationName: metadata['integrationName'],\n       manufacturer: manufacturer\n   },\n   telemetry: {\n       temperature: 42,\n       humidity: 80,\n       rawData: payloadStr\n   }\n};\n\n/** Helper functions **/\n\nfunction decodeToString(payload) {\n   return String.fromCharCode.apply(String, payload);\n}\n\nfunction decodeToJson(payload) {\n   // covert payload to string.\n   var str = decodeToString(payload);\n\n   // parse string to JSON\n   var data = JSON.parse(str);\n   return data;\n}\n\nreturn result;",
      "tbelDecoder": "var data = decodeToJson(payload);\r\n\r\nvar deviceName = data.EUI;\r\nvar deviceType = 'Smoke Detector';\r\nvar groupName = 'Smoke Detectors';\r\n// var customerName = 'Customer A';\r\n// use assetName and assetType instead of deviceName and deviceType\r\n// to automatically create assets instead of devices.\r\n// var assetName = 'Asset A';\r\n// var assetType = 'building';\r\n\r\n\r\n// --- attributes and telemetry objects ---\r\nvar telemetry = {};\r\nvar attributes = {};\r\n// --- attributes and telemetry objects ---\r\n\r\n\r\nvar timestamp = -1;\r\nif(data.ts > 0)\r\n{\r\n    timestamp = data.ts;\r\n}\r\nif (timestamp == -1) {\r\n  timestamp = Date.now();\r\n}\r\n\r\n// You can add some keys manually to attributes or telemetry\r\nattributes.devEui = data.EUI;\r\nattributes.fPort = data.port;\r\n\r\n// You can exclude some keys from the result\r\nvar excludeFromTelemetryList = [\"cmd\", \"EUI\", \"devaddr\", \"seqno\", \"port\", \"time\", \"ts\", \"received_at\"];\r\nvar excludeFromAttributesList = [\"cmd\",\"EUI\", \"devaddr\", \"seqno\", \"port\", \"time\", \"ts\", \"received_at\",\"toa\",\"freq\",\"faultAlarm\",\"smokeAlarm\",\"faultAlarm\",\"interconnectAlarm\",\"lowBatteryAlarm\",\"batteryLevelInPercentage\",\"powerEvent\",\"rssi\",\"snr\",\"confirmed\",\"frm_payload\",\"fcnt\"];\r\n\r\n// Message parsing\r\n// To avoid paths in the decoded objects we passing false value to function as \"pathInKey\" argument.\r\n// Warning: pathInKey can cause already found fields to be overwritten with the last value found, e.g. receive_at from uplink_message will be written receive_at in the root.\r\nvar telemetryData = toFlatMap(data, excludeFromTelemetryList, false);\r\nvar attributesData = {};\r\nattributesData.putAll(toFlatMap(data, excludeFromAttributesList, false));\r\n\r\ntelemetry.putAll(telemetryData);\r\nattributes.putAll(attributesData);\r\n\r\nvar result = {\r\n  deviceName: deviceName,\r\n  deviceType: deviceType,\r\n//  assetName: assetName,\r\n//  assetType: assetType,\r\n//  customerName: customerName,\r\n  groupName: groupName,\r\n  attributes: attributes,\r\n  telemetry: {\r\n    ts: timestamp,\r\n    values: telemetry\r\n  }\r\n};\r\n\r\nreturn result;",
      "encoder": null,
      "tbelEncoder": null,
      "updateOnlyKeys": [
        "manufacturer"
      ]
    },
    "additionalInfo": {
      "description": ""
    },
    "edgeTemplate": false
  }